name: Build Debug APK

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-debug:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Listar proyecto
      run: |
        echo "Tu proyecto tiene:"
        ls -la
        echo ""
        echo "¿Hay build.gradle?"
        [ -f "build.gradle" ] && echo "SÍ" || echo "NO"
        echo ""
        echo "¿Hay app/build.gradle?"
        [ -f "app/build.gradle" ] && echo "SÍ" || echo "NO"
    
    - name: Compilar directamente
      run: |
        echo "=== COMPILACIÓN DIRECTA ==="
        
        # Opción 1: Si hay gradlew
        if [ -f "gradlew" ]; then
          echo "Usando gradlew..."
          chmod +x gradlew
          ./gradlew assembleDebug
          
        # Opción 2: Si hay build.gradle pero no gradlew
        elif [ -f "build.gradle" ]; then
          echo "Instalando Gradle..."
          sudo apt-get update
          sudo apt-get install -y gradle
          gradle assembleDebug
          
        # Opción 3: Si está en app/
        elif [ -f "app/build.gradle" ]; then
          echo "Proyecto en app/"
          if [ -f "../gradlew" ]; then
            chmod +x ../gradlew
            ../gradlew assembleDebug
          else
            sudo apt-get install -y gradle
            gradle assembleDebug
          fi
          
        else
          echo "ERROR: No se encontró proyecto Android"
          exit 1
        fi
        
        echo "Compilación terminada"
    
    - name: Mostrar resultado
      run: |
        echo "=== ¿SE GENERÓ LA APK? ==="
        echo "Buscando archivo .apk..."
        
        # Buscar simple
        APK_FILE=$(find . -name "*debug*.apk" -type f 2>/dev/null | head -1)
        
        if [ -n "$APK_FILE" ]; then
          echo " ¡ÉXITO! APK generada:"
          echo "   Archivo: $APK_FILE"
          echo "   Tamaño: $(ls -lh "$APK_FILE" | awk '{print $5}')"
          echo "   Ruta: $(pwd)/$APK_FILE"
        else
          echo " No se encontró APK debug"
          echo "Buscando cualquier .apk..."
          find . -name "*.apk" -type f 2>/dev/null | head -5
        fi
    
    - name: Ver logs de compilación
      if: failure()
      run: |
        echo "=== ULTIMAS 50 LÍNEAS DE LOG ==="
        find . -name "*.log" -type f -exec tail -50 {} \; 2>/dev/null || echo "No hay logs"