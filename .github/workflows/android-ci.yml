name: Build

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create project structure
        run: |
          mkdir -p app/src/main/java/com/thundertools
          mkdir -p gradle/wrapper

      - name: Create root build.gradle
        run: |
          cat > build.gradle.kts << 'EOF'
          // Top-level build file where you can add configuration options common to all sub-projects/modules.
          plugins {
              id("com.android.application") version "8.2.0" apply false
              id("org.jetbrains.kotlin.android") version "1.9.10" apply false
          }
          
          tasks.register("clean", Delete::class) {
              delete(rootProject.buildDir)
          }
          EOF

      - name: Create settings.gradle
        run: |
          cat > settings.gradle.kts << 'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          
          rootProject.name = "ThunderTools"
          include(":app")
          EOF

      - name: Create app build.gradle
        run: |
          cat > app/build.gradle.kts << 'EOF'
          plugins {
              id("com.android.application")
              id("org.jetbrains.kotlin.android")
          }
          
          android {
              namespace = "com.thundertools"
              compileSdk = 34
              
              defaultConfig {
                  applicationId = "com.thundertools"
                  minSdk = 21
                  targetSdk = 34
                  versionCode = 1
                  versionName = "1.0"
              }
              
              buildTypes {
                  getByName("release") {
                      isMinifyEnabled = false
                  }
              }
              
              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_17
                  targetCompatibility = JavaVersion.VERSION_17
              }
              
              kotlinOptions {
                  jvmTarget = "17"
              }
          }
          
          dependencies {
              implementation("androidx.core:core-ktx:1.12.0")
              implementation("androidx.appcompat:appcompat:1.6.1")
          }
          EOF

      - name: Create AndroidManifest
        run: |
          cat > app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.thundertools">
              
              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:label="ThunderTools"
                  android:theme="@style/Theme.AppCompat.Light">
                  
                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

      - name: Create MainActivity
        run: |
          cat > app/src/main/java/com/thundertools/MainActivity.kt << 'EOF'
          package com.thundertools
          
          import android.app.Activity
          import android.os.Bundle
          
          class MainActivity : Activity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContentView(R.layout.activity_main)
              }
          }
          EOF

      - name: Create layout file
        run: |
          mkdir -p app/src/main/res/layout
          cat > app/src/main/res/layout/activity_main.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:gravity="center"
              android:orientation="vertical">
              
              <TextView
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="Hello ThunderTools!"
                  android:textSize="24sp" />
          </LinearLayout>
          EOF

      - name: Create gradle wrapper properties
        run: |
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF

      - name: Download gradle wrapper
        run: |
          wget https://raw.githubusercontent.com/gradle/gradle/master/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar

      - name: Make gradlew executable
        run: |
          cat > gradlew << 'EOF'
          #!/usr/bin/env bash
          
          ##############################################################################
          ##
          ##  Gradle start up script for UN*X
          ##
          ##############################################################################
          
          # Attempt to set APP_HOME
          # Resolve links: $0 may be a link
          PRG="$0"
          # Need this for relative symlinks.
          while [ -h "$PRG" ] ; do
              ls=`ls -ld "$PRG"`
              link=`expr "$ls" : '.*-> \(.*\)$'`
              if expr "$link" : '/.*' > /dev/null; then
                  PRG="$link"
              else
                  PRG=`dirname "$PRG"`"/$link"
              fi
          done
          SAVED="`pwd`"
          cd "`dirname \"$PRG\"`/" >/dev/null
          APP_HOME="`pwd -P`"
          cd "$SAVED" >/dev/null
          
          APP_NAME="Gradle"
          APP_BASE_NAME=`basename "$0"`
          
          # Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
          DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'
          
          # Use the maximum available, or set MAX_FD != -1 to use that value.
          MAX_FD="maximum"
          
          warn () {
              echo "$*"
          }
          
          die () {
              echo
              echo "$*"
              echo
              exit 1
          }
          
          # OS specific support (must be 'true' or 'false').
          cygwin=false
          msys=false
          darwin=false
          nonstop=false
          case "`uname`" in
            CYGWIN* )
              cygwin=true
              ;;
            Darwin* )
              darwin=true
              ;;
            MINGW* )
              msys=true
              ;;
            NONSTOP* )
              nonstop=true
              ;;
          esac
          
          CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
          
          # Determine the Java command to use to start the JVM.
          if [ -n "$JAVA_HOME" ] ; then
              if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
                  # IBM's JDK on AIX uses strange locations for the executables
                  JAVACMD="$JAVA_HOME/jre/sh/java"
              else
                  JAVACMD="$JAVA_HOME/bin/java"
              fi
              if [ ! -x "$JAVACMD" ] ; then
                  die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME
          
          Please set the JAVA_HOME variable in your environment to match the
          location of your Java installation."
              fi
          else
              JAVACMD="java"
              which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
          
          Please set the JAVA_HOME variable in your environment to match the
          location of your Java installation."
          fi
          
          # Increase the maximum file descriptors if we can.
          if [ "$cygwin" = "false" -a "$darwin" = "false" -a "$nonstop" = "false" ] ; then
              MAX_FD_LIMIT=`ulimit -H -n`
              if [ $? -eq 0 ] ; then
                  if [ "$MAX_FD" = "maximum" -o "$MAX_FD" = "max" ] ; then
                      MAX_FD="$MAX_FD_LIMIT"
                  fi
                  ulimit -n $MAX_FD
                  if [ $? -ne 0 ] ; then
                      warn "Could not set maximum file descriptor limit: $MAX_FD"
                  fi
              else
                  warn "Could not query maximum file descriptor limit: $MAX_FD_LIMIT"
              fi
          fi
          
          # For Darwin, add options to specify how the application appears in the dock
          if $darwin; then
              GRADLE_OPTS="$GRADLE_OPTS \"-Xdock:name=$APP_NAME\" \"-Xdock:icon=$APP_HOME/media/gradle.icns\""
          fi
          
          # For Cygwin or MSYS, switch paths to Windows format before running java
          if $cygwin || $msys ; then
              APP_HOME=`cygpath --path --mixed "$APP_HOME"`
              CLASSPATH=`cygpath --path --mixed "$CLASSPATH"`
              JAVACMD=`cygpath --unix "$JAVACMD"`
              
              # We build the pattern for arguments to be converted via cygpath
              ROOTDIRSRAW=`find -L / -maxdepth 1 -mindepth 1 -type d 2>/dev/null`
              SEP=""
              for dir in $ROOTDIRSRAW ; do
                  ROOTDIRS="$ROOTDIRS$SEP$dir"
                  SEP="|"
              done
              OURCYGPATTERN="(^($ROOTDIRS))"
              # Add a user-defined pattern to the cygpath arguments
              if [ "$GRADLE_CYGPATTERN" != "" ] ; then
                  OURCYGPATTERN="$OURCYGPATTERN|($GRADLE_CYGPATTERN)"
              fi
              # Now convert the arguments
              for i in $@ ; do
                  check=`echo "$i"|grep -E -c "$OURCYGPATTERN" -`
                  check2=`echo "$i"|grep -E -c "^-"`                                 ### Check if argument is an option
                  if [ $check -ne 0 ] && [ $check2 -eq 0 ] ; then                    ### Added a condition
                      i=`cygpath --path --ignore --mixed "$i"`
                  fi
                  NEWARGS="$NEWARGS $i"
              done
              # Roll the args list around exactly as many times as the number of
              # args, so each arg winds up back in the position where it started.
              for i in $NEWARGS ; do
                  shift
              done
          fi
          
          # Collect all arguments for the java command;
          #   * $DEFAULT_JVM_OPTS, $JAVA_OPTS, and $GRADLE_OPTS can contain fragments of
          #     shell script including quotes and variable substitutions, so don't split them.
          #   * Build the classpath from the app classpath variable (CP) and the wrapper jar.
          #   * For Cygwin, convert paths from 'mixed' (posix separator) to Windows style.
          set -- $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS "-classpath" "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$@"
          
          # Split on switch, assign the split part to the $var above, then shift past it.
          while : ; do
              case "$1" in
                -*) false ;;  # Skip switches
                *=*) optarg=`expr "X$1" : '[^=]*=\(.*\)'` ;;
                *) optarg= ;;
              esac
              case "$1" in
                -D*)
                  jvmarg=`expr "X$1" : '-D\([^=]*\)\=\(.*\)'`
                  jvmprops="$jvmprops -D$jvmarg=$optarg"
                  shift
                  ;;
                *)
                  # Argument not a switch, not a -D property=value. End of JVM arguments.
                  break
                  ;;
              esac
          done
          
          exec "$JAVACMD" "$@"
          EOF
          
          chmod +x gradlew

      - name: Build APK
        run: |
          ./gradlew assembleDebug --stacktrace --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: thunder-tools-apk
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 7