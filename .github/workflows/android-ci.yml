name: Build APK con Artefactos

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Hacer gradlew ejecutable
      run: |
        if [ -f "gradlew" ]; then
          chmod +x gradlew
          echo " gradlew preparado"
        else
          echo " No hay gradlew, se usará Gradle instalado"
        fi
    
    - name: Compilar APK Debug
      id: compile
      run: |
        echo "=== COMPILANDO APK DEBUG ==="
        
        # Compilar
        if [ -f "gradlew" ]; then
          ./gradlew clean assembleDebug --no-daemon
        else
          gradle clean assembleDebug
        fi
        
        echo " Compilación completada"
    
    - name: Buscar APK exacta
      id: find-apk
      run: |
        echo "=== BUSCANDO APK GENERADA ==="
        
        # Buscar la APK debug específica
        APK_PATH=$(find . -path "*/outputs/apk/debug/*debug.apk" -type f 2>/dev/null | head -1)
        
        if [ -n "$APK_PATH" ]; then
          echo " APK encontrada: $APK_PATH"
          echo "Tamaño: $(ls -lh "$APK_PATH" | awk '{print $5}')"
          
          # Guardar la ruta para el siguiente paso
          echo "apk-path=$APK_PATH" >> $GITHUB_OUTPUT
          
          # Mostrar estructura
          echo "Estructura del directorio:"
          dir_path=$(dirname "$APK_PATH")
          ls -la "$dir_path/"
        else
          echo " No se encontró APK en la ruta esperada"
          echo "Buscando cualquier APK..."
          find . -name "*.apk" -type f 2>/dev/null
          exit 1
        fi
    
    - name: Subir APK como artefacto (CORREGIDO)
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: ${{ steps.find-apk.outputs.apk-path }}
        retention-days: 7
    
    - name: Subir también AAB si existe
      uses: actions/upload-artifact@v4
      with:
        name: app-bundle
        path: |
          **/*.aab
        if-no-files-found: ignore
        retention-days: 7
    
    - name: Mostrar resumen
      run: |
        echo "=== RESUMEN ==="
        echo " Build completado exitosamente!"
        echo " APK disponible en la pestaña 'Artifacts'"
        echo "  Hora: $(date)"
        echo " SHA: ${{ github.sha }}"