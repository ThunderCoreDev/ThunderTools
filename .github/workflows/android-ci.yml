name: Android CI

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Create Clean gradlew
      run: |
        # Eliminar cualquier gradlew existente
        rm -f gradlew
        
        # Crear nuevo gradlew limpio
        cat > gradlew << 'EOF'
#!/usr/bin/env bash
BASE_DIR="$(cd "$(dirname "$0")" && pwd)"
WRAPPER_JAR="$BASE_DIR/gradle/wrapper/gradle-wrapper.jar"
if [ ! -f "$WRAPPER_JAR" ]; then
    echo "ERROR: gradle-wrapper.jar not found"
    exit 1
fi
exec java -jar "$WRAPPER_JAR" "$@"
EOF
        
        # Hacer ejecutable
        chmod +x gradlew
        
        # Verificar
        echo "=== Verificando gradlew ==="
        head -n1 gradlew
        echo "LÃ­neas totales: $(wc -l < gradlew)"
    
    - name: Setup Gradle Wrapper
      run: |
        # Crear directorios si no existen
        mkdir -p gradle/wrapper
        
        # Crear gradle-wrapper.properties
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
        
        # Descargar gradle-wrapper.jar si no existe
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          echo "Descargando gradle-wrapper.jar..."
          curl -L -o gradle/wrapper/gradle-wrapper.jar \
            https://repo.maven.apache.org/maven2/org/grails/grails-gradle-wrapper/8.2/grails-gradle-wrapper-8.2.jar
        fi
        
        echo "=== Verificando archivos ==="
        ls -la gradle/wrapper/
    
    - name: Verify Project Structure
      run: |
        echo "=== Estructura del proyecto ==="
        ls -la
        echo ""
        echo "=== settings.gradle.kts ==="
        if [ -f "settings.gradle.kts" ]; then
          cat settings.gradle.kts
        else
          echo "ERROR: settings.gradle.kts no encontrado"
          exit 1
        fi
        echo ""
        echo "=== app/build.gradle.kts ==="
        if [ -f "app/build.gradle.kts" ]; then
          echo "app/build.gradle.kts encontrado"
        else
          echo "ERROR: app/build.gradle.kts no encontrado"
          exit 1
        fi
    
    - name: Build APK
      run: ./gradlew :app:assembleDebug --stacktrace
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ThunderTools-APK
        path: app/build/outputs/apk/debug/
