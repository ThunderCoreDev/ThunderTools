name: Build

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create project structure
        run: |
          mkdir -p app/src/main/java/com/thundertools
          mkdir -p app/src/main/res/layout
          mkdir -p gradle/wrapper

      - name: Create root build.gradle
        run: |
          cat > build.gradle.kts << 'EOF'
          // Top-level build file where you can add configuration options common to all sub-projects/modules.
          plugins {
              id("com.android.application") version "8.2.0" apply false
              id("org.jetbrains.kotlin.android") version "1.9.10" apply false
          }
          
          tasks.register("clean", Delete::class) {
              delete(rootProject.buildDir)
          }
          EOF

      - name: Create settings.gradle
        run: |
          cat > settings.gradle.kts << 'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          
          rootProject.name = "ThunderTools"
          include(":app")
          EOF

      - name: Create app build.gradle
        run: |
          cat > app/build.gradle.kts << 'EOF'
          plugins {
              id("com.android.application")
              id("org.jetbrains.kotlin.android")
          }
          
          android {
              namespace = "com.thundertools"
              compileSdk = 34
              
              defaultConfig {
                  applicationId = "com.thundertools"
                  minSdk = 21
                  targetSdk = 34
                  versionCode = 1
                  versionName = "1.0"
              }
              
              buildTypes {
                  getByName("release") {
                      isMinifyEnabled = false
                  }
              }
              
              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_17
                  targetCompatibility = JavaVersion.VERSION_17
              }
              
              kotlinOptions {
                  jvmTarget = "17"
              }
          }
          
          dependencies {
              implementation("androidx.core:core-ktx:1.12.0")
              implementation("androidx.appcompat:appcompat:1.6.1")
          }
          EOF

      - name: Create AndroidManifest
        run: |
          cat > app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.thundertools">
              
              <application
                  android:allowBackup="true"
                  android:label="ThunderTools"
                  android:theme="@style/Theme.AppCompat.Light">
                  
                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

      - name: Create MainActivity
        run: |
          cat > app/src/main/java/com/thundertools/MainActivity.kt << 'EOF'
          package com.thundertools
          
          import android.app.Activity
          import android.os.Bundle
          
          class MainActivity : Activity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContentView(R.layout.activity_main)
              }
          }
          EOF

      - name: Create layout file
        run: |
          cat > app/src/main/res/layout/activity_main.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:gravity="center"
              android:orientation="vertical">
              
              <TextView
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="Hello ThunderTools!"
                  android:textSize="24sp" />
          </LinearLayout>
          EOF

      - name: Create gradle wrapper properties
        run: |
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF

      - name: Download gradle wrapper
        run: |
          wget -q https://raw.githubusercontent.com/gradle/gradle/master/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar

      - name: Setup Gradle Wrapper (Simplified)
        run: |
          # Crear un gradlew simplificado sin problemas de comillas
          cat > gradlew << 'EOF'
          #!/usr/bin/env bash
          
          set -e
          
          # Resolve links
          SCRIPT="$0"
          while [ -h "$SCRIPT" ] ; do
            ls=`ls -ld "$SCRIPT"`
            link=`expr "$ls" : '.*-> \(.*\)$'`
            if expr "$link" : '/.*' > /dev/null; then
              SCRIPT="$link"
            else
              SCRIPT=`dirname "$SCRIPT"`/"$link"
            fi
          done
          
          SAVED="`pwd`"
          cd "`dirname \"$SCRIPT\"`/" >/dev/null
          APP_HOME="`pwd -P`"
          cd "$SAVED" >/dev/null
          
          CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
          
          # Use Java from JAVA_HOME if available
          if [ -n "$JAVA_HOME" ] ; then
            JAVACMD="$JAVA_HOME/bin/java"
          else
            JAVACMD=java
          fi
          
          # Execute Gradle
          exec "$JAVACMD" \
            -Dorg.gradle.appname=gradlew \
            -classpath "$CLASSPATH" \
            org.gradle.wrapper.GradleWrapperMain \
            "$@"
          EOF
          
          chmod +x gradlew

      - name: Create local.properties for Android SDK
        run: |
          # Crear local.properties con la ruta del SDK de Android
          if [ -n "$ANDROID_HOME" ]; then
            echo "sdk.dir=$ANDROID_HOME" > local.properties
          else
            echo "sdk.dir=$HOME/Android/Sdk" > local.properties
          fi

      - name: Install Gradle wrapper properly
        run: |
          # Usar gradle wrapper oficial si es posible
          if ! command -v gradle &> /dev/null; then
            wget -q https://services.gradle.org/distributions/gradle-8.2-bin.zip
            unzip -q gradle-8.2-bin.zip
            export PATH="$PWD/gradle-8.2/bin:$PATH"
          fi
          
          # Crear el wrapper usando gradle
          gradle wrapper --gradle-version=8.2 --distribution-type=bin

      - name: Build APK with Gradle
        run: |
          # Dar permisos al wrapper
          chmod +x gradlew
          
          # Limpiar y construir
          ./gradlew clean
          ./gradlew assembleDebug --no-daemon --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: thunder-tools-apk
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 7