name: Android Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify and fix project structure
        run: |
          echo "Verificando estructura del proyecto..."
          ls -la
          
          # Crear gradlew si no existe
          if [ ! -f "gradlew" ]; then
            echo "Creando gradlew..."
            echo '#!/bin/bash' > gradlew
            echo 'exec java -jar gradle/wrapper/gradle-wrapper.jar "$@"' >> gradlew
            chmod +x gradlew
          fi
          
          # Asegurar que no tenga terminaciones Windows
          sed -i 's/\r$//' gradlew 2>/dev/null || true
          chmod +x gradlew
          
          # Verificar/crear gradle-wrapper.jar
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "Descargando gradle-wrapper.jar..."
            mkdir -p gradle/wrapper
            curl -L -o gradle/wrapper/gradle-wrapper.jar \
              https://github.com/gradle/gradle/raw/v8.5.0/gradle/wrapper/gradle-wrapper.jar
          fi
          
          # Verificar/crear gradle.properties para AndroidX
          if [ ! -f "gradle.properties" ]; then
            echo "Creando gradle.properties..."
            echo "android.useAndroidX=true" > gradle.properties
            echo "android.enableJetifier=true" >> gradle.properties
          fi
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Build APK
        run: |
          echo "Construyendo APK..."
          if [ -x "./gradlew" ]; then
            ./gradlew clean assembleRelease --stacktrace --no-daemon
          else
            echo "Usando gradle directamente..."
            gradle clean assembleRelease --stacktrace --no-daemon
          fi
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: thunder-tools-apk
          path: |
            app/build/outputs/apk/release/*.apk
            */build/outputs/apk/release/*.apk
          if-no-files-found: warn
          retention-days: 7