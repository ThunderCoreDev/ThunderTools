name: ThunderNet Build - WORKING

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: âš™ï¸ Setup Environment
      run: |
        echo "=== VERIFICANDO ARCHIVOS ==="
        ls -la
        echo ""
        echo "=== GRADLE/WRAPPER ==="
        ls -la gradle/wrapper/ || echo "No existe gradle/wrapper"
        echo ""
        
        # Si el JAR no existe o estÃ¡ vacÃ­o, descargarlo
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ] || [ $(stat -c%s "gradle/wrapper/gradle-wrapper.jar") -lt 50000 ]; then
          echo "âš ï¸  JAR no vÃ¡lido, descargando..."
          mkdir -p gradle/wrapper
          wget -q -O gradle/wrapper/gradle-wrapper.jar \
            "https://github.com/gradle/gradle/raw/v8.4/gradle/wrapper/gradle-wrapper.jar"
          echo "âœ… JAR descargado"
          ls -lh gradle/wrapper/gradle-wrapper.jar
        fi
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ðŸ“± Setup Android
      uses: android-actions/setup-android@v3
      
    - name: ðŸ› ï¸ Install Gradle (si es necesario)
      run: |
        # Instalar Gradle como respaldo
        wget -q https://services.gradle.org/distributions/gradle-8.4-bin.zip
        unzip -q gradle-8.4-bin.zip
        export GRADLE_HOME=$PWD/gradle-8.4
        export PATH=$GRADLE_HOME/bin:$PATH
        echo "GRADLE_HOME=$GRADLE_HOME" >> $GITHUB_ENV
        echo "$GRADLE_HOME/bin" >> $GITHUB_PATH
        
    - name: ðŸ—ï¸ Build APK (MÃºltiples intentos)
      run: |
        echo "=== INTENTO 1: Usando gradlew ==="
        if [ -f "./gradlew" ]; then
          chmod +x ./gradlew
          ./gradlew --version || echo "gradlew fallÃ³"
        fi
        
        echo ""
        echo "=== INTENTO 2: Usando gradle directamente ==="
        gradle --version || echo "gradle no disponible"
        
        echo ""
        echo "=== COMPILANDO ==="
        # Intentar con gradlew primero
        if [ -f "./gradlew" ] && ./gradlew tasks --dry-run 2>/dev/null; then
          echo "âœ… Usando gradlew"
          ./gradlew assembleDebug --stacktrace
        else
          echo "âš ï¸  Usando gradle directamente"
          gradle assembleDebug --stacktrace
        fi
        
    - name: ðŸ“¤ Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ThunderNet-APK
        path: app/build/outputs/apk/debug/*.apk
        
    - name: ðŸ“‹ Build Summary
      if: always()
      run: |
        echo "## ðŸ—ï¸ Resultado del Build" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "âœ… **BUILD EXITOSO**" >> $GITHUB_STEP_SUMMARY
          echo "APK generado correctamente" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **BUILD FALLIDO**" >> $GITHUB_STEP_SUMMARY
          echo "No se pudo generar el APK" >> $GITHUB_STEP_SUMMARY
        fi